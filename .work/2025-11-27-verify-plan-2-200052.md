# Plan Review - 2025-11-27 20:00:52

## Metadata
- **Reviewer:** plan-review-agent (Independent review #2 for dual-verification)
- **Date:** 2025-11-27 20:00:52
- **Plan Location:** /Users/tobyhede/psrc/turboshovel/.work/2025-11-27-turboshovel-extraction.md
- **Context:** Independent review #2 for dual-verification

## Status: BLOCKED

## Plan Summary
- **Feature:** Turboshovel Plugin Extraction
- **Scope:** Extract CipherPowers hook system into standalone generic Claude Code plugin
- **Estimated Effort:** 45-60 minutes (19 tasks)

## BLOCKING (Must Address Before Execution)

**Missing Test Verification Before Commit:**
- Description: Task 18 (git commit) happens BEFORE Task 16 (run tests). The plan commits code that hasn't been tested yet.
- Impact: Tests may fail after commit, violating the principle that all tests must pass before committing. Creates commits with broken code.
- Action: Reorder tasks - tests and lint must run and pass BEFORE git init and commit. Suggested order: Tasks 1-15, 16 (tests), 17 (lint), verify both pass, then 18 (git), then 19 (final verification).

**Missing Test Verification Strategy for Removed plan-compliance:**
- Description: Task 16 acknowledges tests "may need adjustment for removed plan-compliance gate" but doesn't specify what to do if tests fail. Task 4 removes plan-compliance.ts but doesn't verify which tests depend on it.
- Impact: Critical tests may be unknowingly removed, or test suite may break during execution with unclear recovery path.
- Action: Add explicit step before Task 4 to identify all tests referencing plan-compliance (grep pattern). Add decision tree in Task 16: if tests fail due to plan-compliance, specifically list which tests need updating and how (update expectations, remove tests, or mock differently).

**Incomplete Rebranding Verification:**
- Description: Task 19 Step 3 searches for cipherpowers references but excludes ".work" and "node_modules". The plan itself is in .work/ and contains cipherpowers references in the preamble (line 3 mentions cipherpowers:executing-plans).
- Impact: False positive "all clear" when cipherpowers references still exist in the plan file itself. The grep will pass but references remain.
- Action: Clarify that the plan file itself is expected to contain cipherpowers references (it's documentation, not code). Update verification to exclude .work/*.md files or document that plan files are exempt from rebranding check.

**Missing TypeScript Compilation Error Strategy:**
- Description: Task 15 assumes build will succeed but doesn't specify what to do if TypeScript compilation errors occur due to missing types, imports, or changed file structure.
- Impact: Build may fail with unclear recovery path, blocking all subsequent tasks.
- Action: Add explicit error handling: "If build fails, review TypeScript errors, verify all imports are updated for new paths, check tsconfig.json paths are correct. Common issues: missing type definitions, incorrect import paths after rebranding."

**Missing Verification that CLI Actually Works:**
- Description: Task 19 Step 1 tests CLI with SessionStart hook but doesn't verify the hook system actually executes gates or loads configuration.
- Impact: CLI may respond with valid JSON but not actually function (gates not loading, context not injecting, commands not executing).
- Action: Add test case that triggers actual gate execution: create test gates.json with simple "echo 'test'" command, verify that command runs and output appears in response. Test both passing and failing gates to verify CONTINUE/BLOCK behavior works.

## SUGGESTIONS (Would Improve Plan Quality)

**Add .gitignore Earlier:**
- Description: Task 13 creates .gitignore but Task 15 (npm install) runs before it. This means node_modules/ might briefly not be ignored.
- Benefit: Prevents accidental git add of node_modules if any git operations happen between tasks.
- Action: Move Task 13 (create root files) before Task 15 (npm install), or at minimum create .gitignore before any npm operations.

**Add Explicit Test for Removed Gates:**
- Description: Task 16 runs test suite but doesn't verify that plan-compliance gate is actually absent from the built system.
- Benefit: Confirms the removal was successful and complete.
- Action: Add verification step: "grep -r 'plan-compliance' dist/ should return no matches" after build succeeds.

**Document Why Example Files Retain Some CipherPowers Context:**
- Description: Task 11 cleans example configs but doesn't explain that example context files (in examples/context/) may reference code review or other concepts from CipherPowers.
- Benefit: Future maintainers understand what's intentionally kept vs what's missed.
- Action: Add note: "Example context files in examples/context/ intentionally contain generic code-review and planning guidance that works for any project."

**Add Verification of Environment Variable Usage:**
- Description: Task 5 renames environment variables but doesn't verify these are the only places they're used.
- Benefit: Catches any missed references in comments, docs, or error messages.
- Action: After Task 5, add: "grep -r 'CIPHERPOWERS' plugin/ --include='*.ts' --include='*.md' --exclude-dir=node_modules to verify all references updated."

**Improve Context File Strategy:**
- Description: Task 14 creates single session-start.md but the plan doesn't specify what happens to example context files from examples/context/.
- Benefit: Clarity on whether example context files are generic enough to keep or need modification.
- Action: Add explicit task after Task 11 to review examples/context/*.md files and verify they're generic (no CipherPowers-specific agent references). Update any that reference rust-agent, plan-review-agent, etc.

**Add Build Artifact Verification:**
- Description: Task 15 verifies dist/ exists but doesn't verify completeness (all source files compiled, gates directory present, etc.).
- Benefit: Catches partial compilation issues early.
- Action: After Task 15 Step 3, add: "Verify dist/gates/index.js and dist/gates/plugin-path.js exist" to confirm gates compiled correctly.

**Add Logging Verification:**
- Description: Task 19 Step 2 tests logging but doesn't verify log file content or format.
- Benefit: Confirms logging actually works, not just that directory is created.
- Action: After Task 19 Step 2, add: "cat the log file and verify it contains expected hook execution details."

## Plan Quality Checklist

**Security & Correctness:**
- [ ] Plan addresses potential security vulnerabilities in design
  - Issue: No security review of what's being copied. Plugin paths, file permissions, etc.
- [x] Plan identifies dependency security considerations
  - Copying package.json as-is with same dependencies
- [x] Plan includes acceptance criteria that match requirements
  - Clear goal: working standalone plugin
- [x] Plan considers concurrency/race conditions if applicable
  - N/A for this extraction task
- [ ] Plan includes error handling strategy
  - BLOCKING: Missing strategy for build failures, test failures
- [x] Plan addresses API/schema compatibility
  - N/A, standalone plugin

**Testing:**
- [ ] Plan includes test strategy (unit, integration, property-based where needed)
  - Tests are copied but strategy for handling removed plan-compliance gate is weak
- [ ] Plan specifies test-first approach (TDD steps)
  - BLOCKING: Tests run AFTER git commit
- [ ] Plan identifies edge cases to test
  - Missing edge cases: CLI with invalid input, missing gates.json, etc.
- [x] Plan emphasizes behavior testing over implementation testing
  - Existing tests assumed to be behavior-focused
- [x] Plan includes test isolation requirements
  - Jest tests are isolated
- [x] Plan specifies clear test names and structure (arrange-act-assert)
  - Existing test structure maintained

**Architecture:**
- [x] Plan maintains Single Responsibility Principle
  - Clean extraction, each file has clear purpose
- [x] Plan avoids duplication (identifies shared logic)
  - Reuses existing TypeScript implementation
- [x] Plan separates concerns clearly
  - Gates, config, dispatcher all separated
- [x] Plan avoids over-engineering (YAGNI - only current requirements)
  - Minimal changes, only what's needed for standalone
- [x] Plan minimizes coupling between modules
  - Existing modular structure maintained
- [x] Plan maintains encapsulation boundaries
  - Internal structure preserved
- [x] Plan keeps modules testable in isolation
  - Tests copied maintain isolation

**Error Handling:**
- [ ] Plan specifies error handling approach (fail-fast vs graceful)
  - BLOCKING: Missing handling for build errors, test failures, missing files
- [ ] Plan includes error message requirements
  - No mention of error messages or logging clarity
- [ ] Plan identifies invariants to enforce
  - No explicit invariants defined (e.g., "all tests must pass before commit")

**Code Quality:**
- [x] Plan emphasizes simplicity over cleverness
  - Straightforward copy-and-modify approach
- [x] Plan includes naming conventions or examples
  - Clear rebranding: CIPHERPOWERS → TURBOSHOVEL
- [x] Plan maintains type safety approach
  - TypeScript preserved
- [x] Plan follows project patterns and idioms
  - Maintains existing patterns
- [x] Plan avoids magic numbers (uses named constants)
  - Not introducing new magic numbers
- [ ] Plan specifies where rationale comments are needed
  - No mention of documenting why plan-compliance was removed
- [ ] Plan includes public API documentation requirements
  - Missing updates to plugin API documentation (if any)

**Process:**
- [ ] Plan includes verification steps for each task
  - Verification exists but BLOCKING: tests run after commit
- [x] Plan identifies performance considerations
  - N/A for extraction task
- [ ] Plan includes linting/formatting verification
  - Lint runs but AFTER commit
- [x] Plan scope matches requirements exactly (no scope creep)
  - Clean scope: extract hooks only
- [x] Plan leverages existing libraries/patterns appropriately
  - Reuses existing TypeScript implementation
- [ ] Plan includes commit strategy (atomic commits)
  - Single commit, but BEFORE tests pass (BLOCKING)

## Plan Structure Quality

**Task Granularity:**
- [x] Tasks are bite-sized (2-5 minutes each)
  - Most tasks are appropriate size
- [x] Tasks are independent (can be done in any order where dependencies allow)
  - Clear dependencies, sequential where needed
- [x] Each task has clear success criteria
  - Verification steps included

**Completeness:**
- [x] Exact file paths specified for all tasks
  - Full absolute paths throughout
- [x] Complete code examples (not "add validation")
  - Complete code for gates/index.ts, package.json, etc.
- [x] Exact commands with expected output
  - All commands include expected output
- [x] References to relevant skills/practices where applicable
  - Line 3 references cipherpowers:executing-plans

**TDD Approach:**
- [ ] Each task follows RED-GREEN-REFACTOR pattern
  - BLOCKING: Tests run AFTER implementation complete and committed
- [ ] Write test → Run test (fail) → Implement → Run test (pass) → Commit
  - BLOCKING: Sequence is implement → commit → test

## Assessment

**Ready for execution?** NO

**Reasoning:**

This plan has a **critical workflow violation**: tests and linting run AFTER the git commit (Tasks 16-17 come after Task 18). This violates the fundamental principle that all tests must pass before committing code.

Additionally, there are **missing error handling strategies** for:
- Build failures (Task 15)
- Test failures after removing plan-compliance gate (Task 16)
- Incomplete rebranding verification (Task 19)

The plan is otherwise well-structured with:
- Clear task breakdown
- Exact file paths and complete code examples
- Appropriate verification steps
- Clean separation of concerns

**Required Changes Before Execution:**

1. **CRITICAL:** Reorder tasks: Tests (16) and Lint (17) MUST run and pass BEFORE Git Init/Commit (18)
2. Add error handling strategy for build failures in Task 15
3. Add explicit test identification and fixing strategy for plan-compliance removal in Task 16
4. Fix rebranding verification to exclude plan documentation files
5. Add gate execution verification to CLI testing (Task 19)

**Assessment of extraction completeness:**

The plan successfully addresses the core extraction requirements:
- Copies all necessary TypeScript files
- Removes CipherPowers-specific gates (plan-compliance)
- Rebrands environment variables and logging
- Cleans example configurations
- Updates documentation

However, it would create a **technically broken commit** (tests not verified before committing), which must be fixed before execution.
